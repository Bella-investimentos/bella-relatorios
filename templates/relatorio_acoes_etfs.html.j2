<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Carteira {{ investor }}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
    h1, h2, h3 { text-transform: uppercase; margin-bottom: 10px; }
    p { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 5px; }
    th { background: #f4f4f4; text-align: center; }
    td { text-align: left; }
    .total td { font-weight: bold; }
    .resumo { margin-bottom: 30px; }
  </style>
</head>
<body>
  {# ===== Macros seguras (evitam Undefined em round) ===== #}
  {% macro money(v) -%}
    {%- if v is defined and v is not none -%}${{ (v|float)|round(2) }}{%- else -%}–{%- endif -%}
  {%- endmacro %}
  {% macro pct(v) -%}
    {%- if v is defined and v is not none and v != 0 -%}{{ ((v|float)*100)|round(2) }}%{%- else -%}–{%- endif -%}
  {%- endmacro %}
  {% macro r2(v) -%}
    {%- if v is defined and v is not none -%}{{ (v|float)|round(2) }}{%- else -%}–{%- endif -%}
  {%- endmacro %}
  {% macro pct1(v) -%}
    {%- if v is defined and v is not none and v != 0 -%}{{ (v|float)|round(1) }}%{%- else -%}–{%- endif -%}
  {%- endmacro %}

  <h1 style="text-align: center; color: blue;">Bella Investimentos</h1>
  <h3 style="text-align: center;">Carteira {{ investor }}</h3>

  <p style="text-align: justify;">
    A proposta é baseada em uma carteira em dólares, no valor de
    <strong>USD {{ r2(total_value) }}</strong>.
    A alocação dos ativos foi cuidadosamente estruturada de acordo com o seu perfil de investidor,
    priorizando a valorização e a preservação de capital.
  </p>
  <p style="text-align: justify;">
    Para facilitar a compra dos ativos na sua corretora, destacamos em vermelho no Excel os códigos dos ativos,
    tornando mais simples a pesquisa e execução das ordens.
  </p>
  <p>Data do relatório: {{ date }}</p>

  <!-- Tabela de Bonds -->
  <h2>Bonds: USD {{ r2(bonds_total) }}</h2>
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Vencimento</th>
        <th>Valor Unid.</th>
        <th>Cupom</th>
        <th>Qtd.</th>
        <th>Investimento</th>
      </tr>
    </thead>
    <tbody>
      {% for b in bonds %}
      <tr>
        <td>{{ b.name }} – cod <span style="color:red">{{ b.code }}</span></td>
        <td>{{ b.maturity }}</td>
        <td style="text-align: center;">{{ money(b.unit_price|default(b.unitPrice)) }}</td>
        <td style="text-align: center;">{{ r2(b.coupon) }}%</td>
        <td style="text-align: center;">{{ b.quantity }}</td>
        <td style="text-align: center;">{{ money(b.investment) }}</td>
      </tr>
      {% endfor %}
      <tr class="total">
        <td colspan="5">Total Bonds</td>
        <td style="text-align: center;">USD {{ r2(bonds_total) }}</td>
      </tr>
    </tbody>
  </table>
  <br><br><br>

  <div class="resumo">
    <h3>Resumo dos Bonds</h3>
    {% for b in bonds %}
    <div style="margin-bottom: 1em;">
      <strong>{{ b.code }}</strong>
      <ul>
        {% for item in b.description %}
          <li style="text-align: justify;">{{ item }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
    <br><br><br>
  </div>
  <br><br><br><br><br><br><br><br>
  {% if stocks %}
    <!-- Tabela de Ações -->
    <h2>Ações: USD {{ r2(stocks_total) }}</h2>
    <table>
      <thead>
        <tr>
          <th>Ação</th>
          <th>Tempo</th>
          <th>Código</th>
          <th>Valor atual</th>
          <th>Preço de entrada</th>
          <th>Preço saída</th>
          <th>Div %</th>
          <th>Qtd.</th>
          <th>Investimento</th>
          <th>Perspectiva valorização</th>
        </tr>
      </thead>
      <tbody>
        {% for a in stocks %}
        <tr>
          <td>{{ a.company_name }}</td>
          <td>D + 1</td>
          <td>{{ a.symbol }}</td>
          <td style="text-align: center;">{{ money(a.unit_price) }}</td>
          <td style="text-align: center;">{{ money(a.ema_20) }}</td>
          <td style="text-align: center;">
            {% if a.target_price is defined and a.target_price is not none %}
              {{ money(a.target_price) }}
            {% else %}–{% endif %}
          </td>
          <td style="text-align: center;">{{ pct(a.dividend_yield) }}</td>
          <td style="text-align: center;">{{ a.quantity }}</td>
          <td style="text-align: center;">{{ money(a.investment) }}</td>
          <td style="text-align: center;">
            {% if a.target_price is defined and a.target_price is not none and a.target_price != 0
                  and a.unit_price is defined and a.unit_price is not none and a.unit_price != 0 %}
              {{ pct1((a.target_price / a.unit_price - 1) * 100) }}
            {% else %}–{% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr class="total">
          <td colspan="9">Total Ações</td>
          <td style="text-align: center;">USD {{ r2(stocks_total) }}</td>
        </tr>
      </tbody>
    </table>
    <br><br><br>

    <div class="resumo">
      <h3>Resumo das Ações</h3>
      {% for a in stocks %}
        <p>
          A ação <strong>{{ a.symbol }}</strong> pertence ao setor de
          <strong>{{ a.sector if a.sector is defined and a.sector else "Indefinido" }}</strong>,
          o preço ideal de entrada é o valor de
          <strong>USD {{ r2(a.ema_20) }}</strong>,
          e possui uma expectativa que alcance o valor de
          <strong>
            {% if a.target_price is defined and a.target_price is not none and a.target_price != 0 %}
              USD {{ r2(a.target_price) }}
            {% else %}
              não informado
            {% endif %}
          </strong>.
          Distribuindo dividendos anuais de {{ pct(a.dividend_yield) }}.
        </p>
        <br><br><br>
        {% if a.chart is defined and a.chart %}
          {% set chart_src = a.chart if 'file:' in a.chart else 'file:///' ~ a.chart %}
          <img src="{{ chart_src }}" alt="Gráfico de {{ a.symbol }}"
              style="max-width: 100%; height: auto; margin-bottom: 20px;">
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
  {# ---------------- AÇÕES DE OPORTUNIDADE ---------------- #}
  {% if opp_stocks %}
    <h2>Ações de Oportunidade: USD {{ r2(opp_stocks_total) }}</h2>
    <table>
      <thead>
        <tr>
          <th>Ação</th>
          <th>Tempo</th>
          <th>Código</th>
          <th>Valor atual</th>
          <th>Preço de entrada</th>
          <th>Preço saída</th>
          <th>Div %</th>
          <th>Qtd.</th>
          <th>Investimento</th>
          <th>Perspectiva valorização</th>
        </tr>
      </thead>
      <tbody>
        {% for a in opp_stocks %}
        <tr>
          <td>{{ a.company_name }}</td>
          <td>D + 1</td>
          <td>{{ a.symbol }}</td>
          <td style="text-align: center;">{{ money(a.unit_price) }}</td>
          <td style="text-align: center;">{{ money(a.ema_20) }}</td>
          <td style="text-align: center;">
            {% if a.target_price is defined and a.target_price is not none %}
              {{ money(a.target_price) }}
            {% else %}–{% endif %}
          </td>
          <td style="text-align: center;">{{ pct(a.dividend_yield) }}</td>
          <td style="text-align: center;">{{ a.quantity }}</td>
          <td style="text-align: center;">{{ money(a.investment) }}</td>
          <td style="text-align: center;">
            {% if a.target_price is defined and a.target_price is not none and a.target_price != 0
                  and a.unit_price is defined and a.unit_price is not none and a.unit_price != 0 %}
              {{ pct1((a.target_price / a.unit_price - 1) * 100) }}
            {% else %}–{% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr class="total">
          <td colspan="9">Total Ações de Oportunidade</td>
          <td style="text-align: center;">USD {{ r2(opp_stocks_total) }}</td>
        </tr>
      </tbody>
    </table>
    <br><br><br>
    {# opcional: mini-resumo + gráfico #}
    <div class="resumo">
      <h3>Resumo – Ações de Oportunidade</h3>
      {% for a in opp_stocks %}
        <p>
          <strong>{{ a.symbol }}</strong> — setor:
          <strong>{{ a.sector if a.sector else "Indefinido" }}</strong>,
          entrada ideal: <strong>USD {{ r2(a.ema_20) }}</strong>,
          alvo:
          <strong>
            {% if a.target_price is defined and a.target_price %}
              USD {{ r2(a.target_price) }}
            {% else %}não informado{% endif %}
          </strong>,
          dividendos: {{ pct(a.dividend_yield) }}.
        </p>
        {% if a.chart %}
          {% set chart_src = a.chart if 'file:' in a.chart else 'file:///' ~ a.chart %}
          <img src="{{ chart_src }}" alt="Gráfico de {{ a.symbol }}"
              style="max-width: 100%; height: auto; margin-bottom: 20px;">
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% if etfs %}
    <!-- Tabela de ETFs -->
    <h2>ETFs: USD {{ r2(etfs_total) }}</h2>
    <table>
      <thead>
        <tr>
          <th>ETF - nome</th>
          <th>Tempo</th>
          <th>Código</th>
          <th>Valor atual</th>
          <th>Preço de entrada</th>
          <th>Div %</th>
          <th>Qtd.</th>
          <th>Investimento</th>
          <th>Expectativa de crescimento</th>
        </tr>
      </thead>
      <tbody>
        {% for a in etfs %}
        <tr>
          <td>{{ a.company_name }}</td>
          <td>D + 1</td>
          <td>{{ a.symbol }}</td>
          <td style="text-align: center;">{{ money(a.unit_price) }}</td>
          <td style="text-align: center;">{{ money(a.ema_20) }}</td>
          <td style="text-align: center;">{{ pct(a.dividend_yield) }}</td>
          <td style="text-align: center;">{{ a.quantity }}</td>
          <td style="text-align: center;">{{ money(a.investment) }}</td>
          <td style="text-align: center;">
            {% if a.average_growth is defined and a.average_growth is not none and a.average_growth != 0 %}
              {{ pct1(a.average_growth) }}
            {% else %}–{% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr class="total">
          <td colspan="8">Total ETFs</td>
          <td style="text-align: center;">USD {{ r2(etfs_total) }}</td>
        </tr>
      </tbody>
    </table>
    <br><br><br>
    <div class="resumo">
      <h3>Resumo dos ETFs</h3>
      {% for a in etfs %}
        <p>
          <strong>{{ a.symbol }}</strong> – {{ a.company_name or a.symbol }} possui
          {% if a.dividend_yield is defined and a.dividend_yield is not none and a.dividend_yield != 0 %}
            dividend yield de {{ ((a.dividend_yield*100)|round(2)) }}% ao ano,
          {% else %}
            dividendos não informados,
          {% endif %}
          o preço ideal de entrada é o valor de
          <strong>USD {{ r2(a.ema_20) }}</strong>, e
          {% if a.average_growth is defined and a.average_growth is not none and a.average_growth != 0 %}
            crescimento médio anual de {{ pct1(a.average_growth) }} com base nos últimos 10 anos
          {% else %}
            dados históricos insuficientes para calcular crescimento médio
          {% endif %}.
        </p>
        <br><br><br>
        {% if a.chart is defined and a.chart %}
          {% set chart_src = a.chart if 'file:' in a.chart else 'file:///' ~ a.chart %}
          <img src="{{ chart_src }}" alt="Gráfico de {{ a.symbol }}"
              style="max-width: 100%; height: auto; margin-bottom: 20px;">
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% if etfs_op %}
    <!-- Tabela de ETFs de Oportunidade -->
    <h2>ETFs de Oportunidade: USD {{ r2(etfs_op_total) }}</h2>
    <table>
      <thead>
        <tr>
          <th>ETF - nome</th>
          <th>Tempo</th>
          <th>Código</th>
          <th>Valor atual</th>
          <th>Preço de entrada</th>
          <th>Div %</th>
          <th>Qtd.</th>
          <th>Investimento</th>
          <th>Expectativa de crescimento</th>
        </tr>
      </thead>
      <tbody>
        {% for a in etfs_op %}
        <tr>
          <td>{{ a.company_name }}</td>
          <td>D + 1</td>
          <td>{{ a.symbol }}</td>
          <td style="text-align: center;">{{ money(a.unit_price) }}</td>
          <td style="text-align: center;">{{ money(a.ema_20) }}</td>
          <td style="text-align: center;">{{ pct(a.dividend_yield) }}</td>
          <td style="text-align: center;">{{ a.quantity }}</td>
          <td style="text-align: center;">{{ money(a.investment) }}</td>
          <td style="text-align: center;">
            {% if a.average_growth is defined and a.average_growth is not none and a.average_growth != 0 %}
              {{ pct1(a.average_growth) }}
            {% else %}–{% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr class="total">
          <td colspan="8">Total ETFs de Oportunidade</td>
          <td style="text-align: center;">USD {{ r2(etfs_op_total) }}</td>
        </tr>
      </tbody>
    </table>
    <br><br><br>
    <div class="resumo">
      <h3>Resumo dos ETFs de Oportunidade</h3>
      {% for a in etfs_op %}
        <p>
          <strong>{{ a.symbol }}</strong> – {{ a.company_name or a.symbol }} possui
          {% if a.dividend_yield is defined and a.dividend_yield is not none and a.dividend_yield != 0 %}
            dividend yield de {{ ((a.dividend_yield*100)|round(2)) }}% ao ano,
          {% else %}
            dividendos não informados,
          {% endif %}
          o preço ideal de entrada é o valor de
          <strong>USD {{ r2(a.ema_20) }}</strong>, e
          {% if a.average_growth is defined and a.average_growth is not none and a.average_growth != 0 %}
            crescimento médio anual de {{ pct1(a.average_growth) }} com base nos últimos 10 anos
          {% else %}
            dados históricos insuficientes para calcular crescimento médio
          {% endif %}.
        </p>
        <br><br><br>
        {% if a.chart is defined and a.chart %}
          {% set chart_src = a.chart if 'file:' in a.chart else 'file:///' ~ a.chart %}
          <img src="{{ chart_src }}" alt="Gráfico de {{ a.symbol }}"
               style="max-width: 100%; height: auto; margin-bottom: 20px;">
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% if etfs_af %}
    <!-- Tabela de ETFs Anti-Frágil -->
    <h2>ETFs Anti-Frágil: USD {{ r2(etfs_af_total) }}</h2>
    <table>
      <thead>
        <tr>
          <th>ETF - nome</th>
          <th>Tempo</th>
          <th>Código</th>
          <th>Valor atual</th>
          <th>Preço de entrada (Anti-Frágil 3%)</th>
          <th>Div %</th>
          <th>Qtd.</th>
          <th>Investimento</th>
          <th>Expectativa de crescimento</th>
        </tr>
      </thead>
      <tbody>
        {% for a in etfs_af %}
        <tr>
          <td>{{ a.company_name }}</td>
          <td>D + 1</td>
          <td>{{ a.symbol }}</td>
          <td style="text-align: center;">{{ money(a.unit_price) }}</td>

          {# >>> diferença: usa antifragile_entry_price #}
          <td style="text-align: center;">
            {% if a.antifragile_entry_price is defined and a.antifragile_entry_price is not none %}
              {{ money(a.antifragile_entry_price) }}
            {% else %}–{% endif %}
          </td>

          <td style="text-align: center;">{{ pct(a.dividend_yield) }}</td>
          <td style="text-align: center;">{{ a.quantity }}</td>
          <td style="text-align: center;">{{ money(a.investment) }}</td>
          <td style="text-align: center;">
            {% if a.average_growth is defined and a.average_growth is not none and a.average_growth != 0 %}
              {{ pct1(a.average_growth) }}
            {% else %}–{% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr class="total">
          <td colspan="8">Total ETFs Anti-Frágil</td>
          <td style="text-align: center;">USD {{ r2(etfs_af_total) }}</td>
        </tr>
      </tbody>
    </table>
    <br><br><br>
    <div class="resumo">
      <h3>Resumo dos ETFs Anti-Frágil</h3>
      {% for a in etfs_af %}
        <p>
          <strong>{{ a.symbol }}</strong> – {{ a.company_name or a.symbol }} possui
          {% if a.dividend_yield is defined and a.dividend_yield is not none and a.dividend_yield != 0 %}
            dividend yield de {{ ((a.dividend_yield*100)|round(2)) }}% ao ano,
          {% else %}
            dividendos não informados,
          {% endif %}
          o preço de entrada anti-frágil é
          <strong>
            {% if a.antifragile_entry_price is defined and a.antifragile_entry_price is not none %}
              USD {{ r2(a.antifragile_entry_price) }}
            {% else %}não informado{% endif %}
          </strong>, e
          {% if a.average_growth is defined and a.average_growth is not none and a.average_growth != 0 %}
            crescimento médio anual de {{ pct1(a.average_growth) }} com base nos últimos 10 anos
          {% else %}
            dados históricos insuficientes para calcular crescimento médio
          {% endif %}.
        </p>
        <br><br><br>
        {% if a.chart is defined and a.chart %}
          {% set chart_src = a.chart if 'file:' in a.chart else 'file:///' ~ a.chart %}
          <img src="{{ chart_src }}" alt="Gráfico de {{ a.symbol }}"
               style="max-width: 100%; height: auto; margin-bottom: 20px;">
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% if cryptos %}
    <!-- Tabela de Criptomoedas -->
    <h2>Criptomoedas</h2>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Código</th>
          <th>Valor atual</th>
          <th>Quantidade</th>
          <th>Investimento</th>
          <th>Valorização (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for a in cryptos %}
        <tr>
          <!-- Nome da criptomoeda -->
          <td style="text-align: center;">{{ a.company_name }}</td>
          
          <!-- Código da criptomoeda -->
          <td style="text-align: center;">{{ a.symbol }}</td>
          
          <!-- Valor atual -->
          <td style="text-align: center;">{{ money(a.unit_price) }}</td>
          
          <!-- Quantidade digitada -->
          <td style="text-align: center;">
            {% if a.quantity is not none %}
              {{ ('%.8f' % a.quantity).rstrip('0').rstrip('.') }}
            {% else %}
              -
            {% endif %}
          </td>
          
          <!-- Valor total (investment) -->
          <td style="text-align: center;">
            {% if a.investment is not none %}
              {{ money(a.investment) }}
            {% else %}
              -
            {% endif %}
          </td>
          
          <!-- Valorização (%) digitada -->
          <td style="text-align: center;">
            {% if a.average_growth is not none %}
              {{ "%.2f"|format(a.average_growth) }}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        <!-- Linha com o total de criptomoedas -->
        <tr class="total">
          <td colspan="5" style="text-align: right;"><strong>Total Criptomoedas</strong></td>
          <td style="text-align: center;">USD {{ r2(cryptos_total) }}</td>
          
        </tr>
      </tbody>
    </table>
    <br><br><br>
  {% endif %}

  {% if real_estates %}
    <!-- Tabela de Imóveis -->
    <h2>Imóveis: USD {{ r2(real_estates_total) }}</h2>
    <table>
      <thead>
        <tr>
          <th>Imóvel - nome</th>
          <th>Valor investido</th>
          <th>Valorização (%)</th>
          <th>Valor esperado</th>
        </tr>
      </thead>
      <tbody>
        {% for r in real_estates %}
        <tr>
          <td>{{ r.symbol }}</td>
          <td style="text-align: center;">{{ money(r.investment) }}</td>
          <td style="text-align: center;">
            {% if r.appreciation_pct is defined and r.appreciation_pct is not none %}
              {{ pct(r.appreciation_pct) }}
            {% else %}–{% endif %}
          </td>
          <td style="text-align: center;">
            {% if r.current_value is defined and r.current_value is not none %}
              {{ money(r.current_value) }}
            {% else %}–{% endif %}
          </td>
        </tr>
        {% endfor %}
        <tr class="total">
          <td colspan="3">Total Imóveis</td>
          <td style="text-align: center;">USD {{ r2(real_estates_total) }}</td>
        </tr>
      </tbody>
    </table>
    <br><br><br>
  {% endif %}

</body>
</html>
